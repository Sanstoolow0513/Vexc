{
  "permissions": {
    "allow": [
      "WebSearch",
      "mcp__web-reader__webReader",
      "Bash(\"C:\\\\Users\\\\Sanstoolow\\\\Desktop\\\\Vexc\\\\CLAUDE.md\" << 'EOF'\n# CLAUDE.md\n\nThis file provides guidance to Claude Code \\(claude.ai/code\\) when working with code in this repository.\n\n## Project Overview\n\nVexc is a desktop code editor built with Tauri + React + TypeScript, inspired by VSCode. The project aims to provide a lightweight, fast, and secure local-first coding experience.\n\n**Current Status**: Foundation phase \\(M0\\) - building workbench layout, editor engine, and backend file commands.\n\n## Development Commands\n\n### Core Development\n- `pnpm tauri dev` - Start development server with hot reload \\(Vite on port 1420\\)\n- `pnpm build` - Build frontend for production \\(outputs to `dist/`\\)\n- `pnpm tauri build` - Build complete desktop application \\(outputs to `src-tauri/target/release/bundle/`\\)\n\n### Package Management\n- Uses `pnpm` as package manager\n- `pnpm install` - Install dependencies\n\n### Development URLs\n- Frontend dev server: `http://localhost:1420`\n- Tauri automatically updates `tauri.conf.json` devUrl when using `pnpm tauri dev`\n\n### Platform-Specific\n- Desktop: Works on Windows, macOS, Linux\n- Android: `pnpm tauri android init` then `pnpm tauri android dev`\n\n## Architecture\n\n### Frontend Structure \\(React + TypeScript\\)\n\n**Entry Point**: `src/main.tsx` → `src/App.tsx`\n\n**Core Modules**:\n- `src/api.ts` - Tauri command wrappers \\(invoke backend commands\\)\n- `src/types.ts` - Shared TypeScript types \\(mirrored in Rust\\)\n- `src/utils.ts` - Helper functions \\(language detection, path handling, arg parsing\\)\n- `src/hints.ts` - Keyword-based code suggestion system \\(defined but not yet integrated in UI\\)\n\n**Window Management**:\n- Custom window frame \\(`decorations: false` in tauri.conf.json\\)\n- Custom title bar with drag region \\(`data-tauri-drag-region`\\)\n- Window controls \\(minimize, maximize/close\\) implemented manually\n\n**State Management Pattern**:\n- Centralized in `App.tsx` using React hooks \\(useState, useEffect, useMemo\\)\n- No external state library - uses refs for stale closure prevention\n- Local state stored in `localStorage` for workspace persistence\n- **Refs Sync Pattern**: Critical state values have corresponding refs synchronized via useEffect:\n  ```typescript\n  const [tabs, setTabs] = useState<EditorTab[]>\\([]\\);\n  const tabsRef = useRef<EditorTab[]>\\([]\\);\n\n  useEffect\\(\\(\\) => {\n    tabsRef.current = tabs;\n  }, [tabs]\\);\n  ```\n  This ensures async callbacks always access the latest state without stale closures.\n\n**Editor**: Monaco Editor \\(`@monaco-editor/react`\\)\n- Mounted in `App.tsx`, ref stored for programmatic control\n- Custom One Dark Pro theme defined in `handleEditorMount` \\(orange variant\\)\n- Handles keyboard shortcuts \\(Ctrl+S for save, Tab for hints, Escape to close hints\\)\n- Editor options: word wrap on, minimap disabled, 13px font, 2-space tabs\n\n**Terminal Integration** \\(xterm.js\\):\n- Uses `@xterm/xterm` with `@xterm/addon-fit` for auto-sizing\n- Single visible terminal instance switched between sessions via `redrawTerminal\\(\\)`\n- Real-time output via Tauri event system \\(`terminal://output`\\)\n- PowerShell spawns with `-NoLogo -NoProfile` arguments on Windows\n\n### Backend Structure \\(Rust + Tauri\\)\n\n**Entry Point**: `src-tauri/src/lib.rs` - `run\\(\\)` function registers all commands\n\n**State**: `AppState` struct with:\n- `workspace_root: Mutex<Option<PathBuf>>` - Current workspace directory\n- `terminals: Mutex<HashMap<String, Arc<Mutex<TerminalState>>>>` - Terminal sessions\n- `terminal_counter: AtomicU64` - Session ID generator\n\n**Security Model**:\n- All file operations must stay within workspace boundary\n- `ensure_inside_workspace\\(\\)` validates paths before read/write\n- Binary file detection via null byte scanning\n- Hidden file filtering \\(configurable via `includeHidden` parameter\\)\n\n**Tauri Commands** \\(invoked from frontend\\):\n- `set_workspace`, `get_workspace` - Workspace management\n- `list_directory`, `read_file`, `write_file` - File operations\n- `search_workspace` - Recursive text search \\(max 200 hits default\\)\n- `terminal_create`, `terminal_list`, `terminal_snapshot`, `terminal_write`, `terminal_close` - Terminal session management\n- `ai_provider_suggestions`, `ai_run` - AI CLI integration\n\n**Data Flow**:\n1. Frontend calls function in `src/api.ts`\n2. API function uses `invoke<Type>\\(\"command_name\", { args }\\)`\n3. Tauri bridges to Rust command handler in `lib.rs`\n4. Rust returns `Result<Type, String>` \\(error message as String\\)\n5. Frontend receives Promise<Type>\n\n**Event System** \\(Rust → Frontend\\):\n- Backend emits `terminal://output` events with `TerminalOutputEvent` payload\n- Frontend listens via `listen<TerminalOutputEvent>\\(\"terminal://output\", handler\\)`\n- Enables real-time terminal output streaming without polling\n- Events automatically sync to visible terminal session via `activeTerminalIdRef`\n\n### Type Synchronization\n\nTypeScript types in `src/types.ts` must match Rust structs in `lib.rs`:\n- Use `#[serde\\(rename_all = \"camelCase\"\\)]` on Rust structs for TypeScript compatibility\n- `Option<T>` in Rust maps to `T | null` in TypeScript\n- `Vec<T>` maps to `T[]`\n- All commands return `Result<T, String>` for error handling\n\n### UI Layout\n\n**Workbench Grid** \\(CSS in `src/App.css`\\):\n- **Top bar**: Workspace controls + view toggle + actions\n- **Left sidebar**: File tree explorer + search panel\n- **Center**: Tab strip + Monaco editor surface\n- **Bottom panel**: Terminal / AI assistant \\(toggleable\\)\n- **Status bar**: Feedback messages\n\n**Key UI Patterns**:\n- Lazy-loaded directory tree \\(fetches children on expand\\)\n- Tab-based editing with dirty state tracking \\(`content !== savedContent`\\)\n- Virtual terminal sessions \\(line-based, not PTY\\)\n- **Monaco Editor Theming**: Custom One Dark Pro theme defined in `handleEditorMount`:\n  - Token colors: keywords \\(#c678dd\\), strings \\(#98c379\\), functions \\(#61afef\\), etc.\n  - Custom background \\(#0a0c10\\) and selection colors\n- **Terminal Write Queue**: Uses Promise chain to serialize terminal input:\n  ```typescript\n  terminalWriteQueueRef.current = terminalWriteQueueRef.current\n    .then\\(\\(\\) => terminalWrite\\(sessionId, data\\)\\)\n  ```\n  Prevents race conditions from rapid terminal input.\n- **Keyboard Shortcuts \\(Dual Layer\\)**: Ctrl+S handled both in Monaco editor\n  \\(`editor.addCommand`\\) and globally \\(`window.addEventListener`\\) for reliability\n- **Browser Close Protection**: `beforeunload` event prevents accidental window\n  closure when dirty tabs exist \\(`hasDirtyTabs` check\\)\n\n### AI CLI Integration\n\n**Placeholder System**:\n- AI commands support template variables: `{prompt}`, `{workspace}`\n- Example template: `[\"{prompt}\"]` or `[\"--workspace\", \"{workspace}\", \"{prompt}\"]`\n- Runtime replacement in `ai_run` Rust command\n- Built-in providers: `codex`, `claude`, `gemini` \\(configurable via `aiProviderSuggestions`\\)\n- Working directory defaults to workspace root, custom CWD validated against workspace boundary\n\n### Phase 1 Scope \\(from PROJECT_PLAN.md\\)\n\n**Included**:\n- Open folder/workspace\n- File tree navigation\n- Multi-tab editing with unsaved state indicators\n- Global workspace search\n- Integrated terminal \\(Windows priority - PowerShell default\\)\n- Basic Git visibility \\(planned\\)\n- Command palette \\(planned\\)\n\n**Excluded**:\n- Full extension marketplace\n- Debug adapter ecosystem\n- Cloud sync/collaboration\n- Full VSCode settings ecosystem\n\n### Important Constraints\n\n1. **Workspace Boundary**: All file I/O must validate paths are within workspace root\n2. **Binary File Protection**: Detect and prevent opening binary files via null byte scanning \\(>2MB limit for search, 1MB limit for editor\\)\n3. **Terminal Session Isolation**: Each terminal maintains its own CWD and line buffer,\n   with scrollback limited to 1,800 lines to prevent memory issues\n4. **State Synchronization**: Use refs \\(`tabsRef`, `activeTabIdRef`, etc.\\) to avoid stale closures in async operations\n5. **Error Messages**: All Rust errors return as `String`, displayed in status bar\n6. **Ignored Directories**: `node_modules`, `dist`, `target` are automatically excluded from file tree and search\n\n### Key Constants\n\n**Backend \\(`src-tauri/src/lib.rs`\\)**:\n- `MAX_EDITOR_FILE_BYTES = 1,048,576` \\(1MB\\) - Maximum file size for editor\n- Search file limit: 2MB per file\n- Terminal scrollback limit: 1,800 lines\n- Search results default limit: 200 hits\n\n**Frontend \\(`src/App.tsx`\\)**:\n- `WORKSPACE_STORAGE_KEY = \"vexc.workspacePath\"` - localStorage key for workspace persistence\n\n### Development Workflow\n\n1. Backend changes: Edit `src-tauri/src/lib.rs`, restart `pnpm tauri dev`\n2. Frontend changes: Hot reload via Vite \\(most changes apply immediately\\)\n3. Type changes: Update both `src/types.ts` and corresponding Rust structs\n4. Testing: Manual testing in dev mode \\(no automated tests yet - M3 milestone\\)\n\n### TypeScript Configuration\n\n**`tsconfig.json`**:\n- Strict mode enabled \\(`strict: true`\\)\n- Unused locals/parameters checks enabled\n- `target: ES2020`, `module: ESNext`\n- `jsx: react-jsx` \\(new JSX transform\\)\n- `moduleResolution: bundler` for Vite compatibility\n\n### Windows-Specific Notes\n\n- Default terminal: `powershell.exe` with `-NoLogo -NoProfile` arguments\n- Path handling: Normalized to forward slashes in frontend, uses OS-native paths in backend\n- Build target: Works on Windows 11 IoT Enterprise LTSC \\(dev environment\\)\n- Terminal output normalization: `\\\\r\\\\n` and `\\\\r` converted to `\\\\n` for consistent line handling\n\n### Key Functions Reference\n\n**Frontend - `src/api.ts`**:\n- `setWorkspace\\(path\\)` → Initialize workspace\n- `getWorkspace\\(\\)` → Retrieve current workspace info\n- `listDirectory\\(path?, includeHidden?\\)` → Get file nodes\n- `readFile\\(path\\)` → Load file content\n- `writeFile\\(path, content\\)` → Save file\n- `searchWorkspace\\(query, maxResults?, includeHidden?\\)` → Text search\n- `terminalCreate\\(shell?\\)` → Start new terminal session\n- `terminalList\\(\\)` → List all terminal sessions\n- `terminalSnapshot\\(sessionId\\)` → Get terminal buffer snapshot\n- `terminalWrite\\(sessionId, input\\)` → Execute command in terminal\n- `terminalClose\\(sessionId\\)` → Close terminal session\n- `aiProviderSuggestions\\(\\)` → Get available AI CLI providers\n- `aiRun\\(request\\)` → Execute AI command with workspace context\n\n**Frontend - `src/utils.ts`**:\n- `detectLanguage\\(path\\)` → Map file extension to Monaco language\n- `fileNameFromPath\\(path\\)` → Extract filename from full path\n- `splitArgs\\(input\\)` → Parse shell-like argument string \\(handles quotes\\)\n\n**Backend - Security Helpers**:\n- `ensure_inside_workspace\\(candidate, workspace_root\\)` → Path boundary validation\n- `is_probably_binary\\(bytes\\)` → Detect binary files via null bytes \\(first 1KB scanned\\)\n- `canonicalize_dir_path\\(path\\)` → Resolve and validate directory path\n- `build_terminal_spawn_command\\(shell, cwd\\)` → Build platform-specific shell command\n  - PowerShell/pwsh: Adds `-NoLogo -NoProfile` flags\n  - Other shells: Uses default command behavior\n\n### Milestones Tracking\n\nCurrent phase aims to complete M0 \\(Foundation\\):\n- Workbench layout ✅\n- Editor engine integration ✅\n- Backend file commands ✅\n- Terminal session management ✅\n- AI CLI integration ✅\n\nNext: M1 \\(Core Editing\\) - Enhance file operations, dirty state handling, workspace search.\nEOF)",
      "mcp__zread__read_file"
    ]
  }
}
